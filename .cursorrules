# Cursor Rules - MVP Directorio de PodÃ³logos

## ğŸ—ï¸ Arquitectura: BFF Pattern

**Flujo**: Cliente â†’ Next.js API Routes (`/api/v1/...`) â†’ NestJS Backend (privado) â†’ DB

**Reglas CrÃ­ticas:**
- âŒ Cliente NUNCA llama directamente a NestJS
- âœ… Usa SIEMPRE pnpm y pnpx (NUNCA npm/npx)
- âœ… Cliente siempre llama a Next.js API Routes
- âœ… Next.js API Routes llaman internamente a NestJS (BACKEND_API_URL)
- âœ… NestJS NO accesible pÃºblicamente, solo desde servidor Next.js
- âœ… Variables `BACKEND_API_URL` y `BACKEND_API_KEY` solo server-side (nunca NEXT_PUBLIC_*)
- âœ… Variables de entorno en UPPER_SNAKE_CASE (ej: `DATABASE_URL`, `JWT_SECRET`)
- âœ… Nunca crees datos con mock, usa seeding para generar todos los datos falsos
- Una tarea no se puede marcar como completada si no supera el 85% de los test

## ğŸ“ Estructura del Monorepo

```
/
â”œâ”€â”€ client/          # Next.js (Frontend + BFF Layer)
â”‚   â””â”€â”€ app/api/v1/  # Next.js API Routes (BFF)
â”œâ”€â”€ api/             # NestJS (Backend privado)
â”‚   â””â”€â”€ src/modules/ # MÃ³dulos NestJS
â”œâ”€â”€ utils/           # CÃ³digo compartido
â”‚   â”œâ”€â”€ lib/         # LibrerÃ­as compartidas
â”‚   â””â”€â”€ config/      # Configuraciones compartidas
â”œâ”€â”€ config/           # Configuraciones globales
â”œâ”€â”€ docs/             # DocumentaciÃ³n del proyecto
â”‚   â””â”€â”€ plans/       # Registros de implementaciÃ³n
â”œâ”€â”€ .env              # Variables de entorno (raÃ­z)
â”œâ”€â”€ package.json      # Scripts raÃ­z + dependencias compartidas
â””â”€â”€ pnpm-workspace.yaml
```

## ğŸ“ Convenciones

### Naming
- Archivos: snake_case (`user_service.ts`)
- Clases: PascalCase (`UserService`)
- Funciones/Variables: camelCase (`getUserById`)
- Constantes: UPPER_SNAKE_CASE (`MAX_RETRIES`)
- Tipos: PascalCase (`UserDto`)
- Variables de entorno: UPPER_SNAKE_CASE (`DATABASE_URL`, `JWT_SECRET`)

### DocumentaciÃ³n
- **Naming**: `##_snake_case.md` (ej: `01_prd.md`, `02_arquitectura.md`)
- **LÃ­mite**: MÃ¡ximo 200 lÃ­neas por archivo (excepto `.cursorrules`, `CLOUDE.md`, `.github/`)
- **Si excede**: Crear archivo secundario con indexaciÃ³n
- **Estilo**: Directo, preciso, informaciÃ³n relevante, estilo SaaS-tÃ©cnico (PRD para inversores)
- **UbicaciÃ³n**: `docs/` en raÃ­z del proyecto

### Estructura de CÃ³digo Compartido

**`/utils/lib`**: LibrerÃ­as compartidas entre client y api
- Funciones utilitarias
- Helpers comunes
- Validadores compartidos

**`/utils/config`**: Configuraciones compartidas
- Configuraciones de DB, JWT, Stripe, etc.
- Variables de entorno validadas y tipadas
- **NO** duplicar configs en client o api
- Importar siempre desde `/utils/config`

**`/config`** (raÃ­z): Configuraciones globales
- Configuraciones de build
- Configuraciones de herramientas
- No variables de entorno (estas van en `.env`)

## ğŸš€ Scripts del Monorepo

**package.json raÃ­z** debe contener scripts para:
- Levantar solo client: `pnpm run dev:client`
- Levantar solo api: `pnpm run dev:api`
- Levantar ambos: `pnpm run dev:all` (usando concurrently)

**Cada proyecto** (client/api) tiene su propio `package.json` con lo indispensable.

**Dependencias compartidas** van en `package.json` raÃ­z.

## ğŸ¯ Principios SOLID

- **S**ingle Responsibility: Una responsabilidad por clase/funciÃ³n
- **O**pen/Closed: Abierto a extensiÃ³n, cerrado a modificaciÃ³n
- **L**iskov Substitution: Subtipos sustituibles
- **I**nterface Segregation: Interfaces especÃ­ficas
- **D**ependency Inversion: Depender de abstracciones

## ğŸ”§ Robustez y Escalabilidad

**Robustez:**
- ValidaciÃ³n exhaustiva server-side
- Manejo errores con cÃ³digos especÃ­ficos
- Logging estructurado
- Transacciones DB cuando necesario
- Rollback strategies

**Escalabilidad:**
- CÃ³digo stateless
- CachÃ© estratÃ©gico (Next.js BFF)
- Queries optimizadas (Ã­ndices, select)
- PaginaciÃ³n en listas
- Rate limiting
- Horizontal scaling ready

## ğŸ“ Stack TecnolÃ³gico

**Frontend**: Next.js 14 + TypeScript + Tailwind + shadcn/ui
- Server Components para datos (SEO)
- Client Components para interactividad
- React Hook Form + Zod

**BFF Layer**: Next.js API Routes (`client/app/api/v1/*`)
- Endpoints pÃºblicos
- Auth: JWT cookies httpOnly
- TransformaciÃ³n, cachÃ©, rate limiting

**Backend**: NestJS (privado)
- MÃ³dulos por dominio
- Prisma ORM
- Passport.js auth
- API Key desde Next.js

**Database**: PostgreSQL 15 (Docker) + Redis
- NormalizaciÃ³n 3NF
- Prisma Migrate

## ğŸ” Seguridad

- JWT (15min) + Refresh tokens (7 dÃ­as) | Cookies httpOnly | Bcrypt (12 rounds)
- ValidaciÃ³n server-side siempre | Guards basados en roles
- Rate limiting: 100/15min anÃ³nimo, 1000 autenticado, 5000 admin
- SQL injection protection (Prisma)

## ğŸš€ Performance

- Server Components SSR | Lazy loading imÃ¡genes | Code splitting | CachÃ© BFF layer
- Queries optimizadas | Connection pooling | Background jobs

## ğŸ“Š Logging y Monitoreo

- Structured logging (JSON) | Niveles: ERROR, WARN, INFO, DEBUG
- Context: userId, requestId, timestamp | No loguear informaciÃ³n sensible
- MÃ©tricas: response time, error rate, request rate

## ğŸ“š DocumentaciÃ³n

### Antes de Implementar
**SIEMPRE** revisar `/docs/`:
- `01_prd.md` - Requisitos
- `02_arquitectura.md` - Arquitectura BFF
- `03_especificacion_api.md` - Endpoints
- `04_modelo_entidad_relacion.md` - Modelo datos
- `05_stack_tecnologico.md` - Decisiones tÃ©cnicas

### DespuÃ©s de Implementar
**OBLIGATORIO**: Crear `./docs/plans/##-[nombre].md` (mÃ¡x 200 lÃ­neas)

**Formato**: `01-autenticacion-jwt.md`, `02-sistema-reservas.md`, etc.

**Contenido**:
- DescripciÃ³n implementada
- Arquitectura/patrÃ³n usado
- Decisiones tÃ©cnicas
- Dependencias y relaciones
- Testing implementado
- Tiempo estimado para completar
- Estado: âšªï¸ ğŸ”µ ğŸŸ¡ ğŸŸ¢

## â“ CuÃ¡ndo Preguntar

**SIEMPRE pregunta si:**
- No estÃ¡ claro en documentaciÃ³n
- MÃºltiples formas vÃ¡lidas de implementar
- Necesitas mÃ¡s contexto
- Trade-offs importantes
- Necesitas aclarar prioridades

**NO asumas:**
- Decisiones arquitectÃ³nicas
- Cambios en modelo datos
- Nuevas dependencias
- Modificaciones APIs sin revisar impacto

## âœ… Checklist Pre-Commit

- [ ] Revisada documentaciÃ³n `/docs/`
- [ ] Arquitectura BFF respetada
- [ ] Principios SOLID aplicados
- [ ] ValidaciÃ³n server-side
- [ ] Manejo errores robusto
- [ ] Tests escritos
- [ ] Archivo registro en `./docs/plans/`
- [ ] CÃ³digo tipado estrictamente
- [ ] Sin cÃ³digo comentado/console.logs
- [ ] Performance optimizada
- [ ] Seguridad verificada
- [ ] Variables de entorno en UPPER_SNAKE_CASE
- [ ] Seeding implementado (no mocks)

## ğŸ¨ Estados

âšªï¸ Pendiente | ğŸ”µ En Progreso | ğŸŸ¡ Necesita RevisiÃ³n | ğŸŸ¢ Completado

**Nota**: Solo si supera el 85% del testing se marca como completado
