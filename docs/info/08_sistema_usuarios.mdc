# 08 - Sistema de Usuarios

**Versión**: 1.0 | **Fecha**: Enero 2026 | **Estado**: ⚪️ Pendiente

---

## Resumen Ejecutivo

Sistema de autenticación y autorización multi-rol (Paciente, Podólogo, Admin) con JWT, recuperación de contraseña, verificación de email y gestión de permisos. Integración con BFF pattern (Next.js API Routes).

---

## Audiencia

- **Desarrolladores Backend**: Implementación autenticación
- **Desarrolladores Frontend**: Integración UI
- **Usuarios**: Flujos de registro/login

---

## Roles y Permisos

### Rol: Paciente
**Permisos**:
- Ver directorio público
- Buscar podólogos
- Ver perfiles profesionales
- Reservar citas
- Dejar reseñas (post-cita)
- Gestionar perfil personal
- Ver historial de citas

**Restricciones**:
- No puede ver dashboard podólogos
- No puede verificar podólogos
- No puede acceder área admin

### Rol: Podólogo
**Permisos**:
- Todo lo de Paciente +
- Gestionar perfil profesional
- Ver métricas de perfil
- Gestionar disponibilidad
- Ver citas recibidas
- Responder reseñas
- Gestionar suscripción

**Restricciones**:
- No puede verificar otros podólogos
- No puede acceder área admin

### Rol: Admin
**Permisos**:
- Todo lo anterior +
- Verificar podólogos
- Gestionar usuarios
- Ver métricas globales
- Moderar reseñas
- Gestionar planes y suscripciones
- Acceso completo a datos

---

## Autenticación

### Registro Paciente
1. Formulario: Email, password, nombre, apellidos
2. Validación email (formato + dominio)
3. Password: Mínimo 8 caracteres, 1 mayúscula, 1 número
4. Hash password (bcrypt, 12 rounds)
5. Crear usuario con rol "PATIENT"
6. Email verificación enviado
7. Estado: "Pendiente verificación email"

### Registro Podólogo
- Ver `05_onboarding_podologos.mdc` (flujo completo)

### Login
1. Formulario: Email + password
2. Validar credenciales (hash comparison)
3. Verificar email confirmado
4. Verificar cuenta activa (no suspendida)
5. Generar JWT (access + refresh tokens)
6. Set cookies httpOnly (Next.js)
7. Redirect según rol:
   - Paciente → `/dashboard/paciente`
   - Podólogo → `/dashboard/podologo`
   - Admin → `/dashboard/admin`

### JWT Tokens
- **Access Token**: 15 minutos, payload: userId, role, email
- **Refresh Token**: 7 días, almacenado en DB (hashed)
- **Renovación**: Automática si refresh token válido
- **Revocación**: Logout invalida refresh token

---

## Recuperación de Contraseña

### Flujo
1. Usuario clic "¿Olvidaste tu contraseña?"
2. Input email
3. Generar token único (UUID, expira 1 hora)
4. Guardar token en DB (hashed)
5. Email con link: `/auth/reset-password?token=...`
6. Usuario clic link → Validar token
7. Formulario nueva contraseña
8. Validar nueva password (mismas reglas)
9. Hash nueva password
10. Invalidar token usado
11. Email confirmación cambio
12. Redirect a login

### Seguridad
- Token único por solicitud
- Expiración 1 hora
- Un solo uso (invalidar tras uso)
- Rate limiting: 3 intentos/hora por email

---

## Verificación de Email

### Flujo
1. Usuario registrado → Email con link verificación
2. Link: `/auth/verify-email?token=...`
3. Validar token (expira 24 horas)
4. Marcar email como verificado
5. Activar cuenta
6. Redirect a login con mensaje éxito

### Reenvío
- Botón "Reenviar email" en estado pendiente
- Rate limiting: 1 email cada 5 minutos

---

## Gestión de Sesión y Seguridad

### Cookies
- **httpOnly**: true, **secure**: true (HTTPS), **sameSite**: "strict", **maxAge**: 7 días

### Middleware Next.js
- Verificar JWT en requests protegidos, refresh automático, redirect a login si no autenticado

### Protección
- **Rutas**: Middleware Next.js + Guards NestJS, Rate limiting (5 intentos/15min por IP)
- **Validación**: Input sanitization, Prisma ORM (SQL injection), XSS (escapar output, CSP), CSRF tokens
- **Password**: Bcrypt (12 rounds), nunca plaintext, reset con token único

---

## Integración BFF

### Next.js API Routes
- `/api/v1/auth/login` → POST
- `/api/v1/auth/register` → POST
- `/api/v1/auth/logout` → POST
- `/api/v1/auth/refresh` → POST
- `/api/v1/auth/forgot-password` → POST
- `/api/v1/auth/reset-password` → POST
- `/api/v1/auth/verify-email` → GET

### Flujo
1. Cliente → Next.js API Route
2. Next.js valida input
3. Next.js → NestJS (BACKEND_API_URL)
4. NestJS procesa lógica
5. NestJS → Next.js (response)
6. Next.js set cookies + response cliente

---

## Criterios de Aceptación

- [ ] Registro paciente funcional
- [ ] Login multi-rol implementado
- [ ] JWT tokens generados correctamente
- [ ] Recuperación contraseña operativa
- [ ] Verificación email funcional
- [ ] Protección de rutas implementada
- [ ] Seguridad validada (OWASP Top 10)
- [ ] Integración BFF funcional

---

## Referencias

- `05_onboarding_podologos.mdc` - Registro podólogos
- `09_dashboard_metricas.mdc` - Acceso según rol
- `17_requisitos_tecnicos.mdc` - Seguridad técnica

---

**Estado**: ⚪️ Pendiente | **Autor**: Backend Team | **Próxima revisión**: Febrero 2026
